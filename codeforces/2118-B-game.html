<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Maestro (矩阵大师) - Brain Training Game</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f39c12;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --bg-color: #f5f6fa;
            --cell-size: 60px;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-container {
            display: flex;
            gap: 40px;
            margin-top: 20px;
        }

        .matrix-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .matrix-row {
            display: flex;
            gap: 5px;
        }

        .matrix-cell {
            width: var(--cell-size);
            height: var(--cell-size);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .matrix-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .matrix-cell.selected {
            background-color: var(--primary-color);
            color: white;
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .game-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-box {
            padding: 10px;
            border-radius: 8px;
            background: var(--primary-color);
            color: white;
            text-align: center;
        }

        .memory-challenge {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: none;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: var(--primary-color);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .operation-preview {
            margin-top: 20px;
            padding: 10px;
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            text-align: center;
        }

        .hint-system {
            margin-top: 20px;
            padding: 10px;
            background: rgba(74, 144, 226, 0.1);
            border-radius: 8px;
        }

        @keyframes flash {
            0% { background-color: white; }
            50% { background-color: var(--secondary-color); }
            100% { background-color: white; }
        }

        .flash {
            animation: flash 1s;
        }

        .tutorial-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            max-width: 80%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .tutorial-modal h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .tutorial-section {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background: rgba(74, 144, 226, 0.1);
        }

        .tutorial-section h3 {
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .tutorial-section ul {
            list-style-type: none;
            padding-left: 20px;
        }

        .tutorial-section li {
            margin: 10px 0;
            position: relative;
        }

        .tutorial-section li:before {
            content: "•";
            color: var(--primary-color);
            font-weight: bold;
            position: absolute;
            left: -15px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--primary-color);
        }

        .tutorial-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .example-matrix {
            font-family: monospace;
            white-space: pre;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .memory-master-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            padding: 30px;
            overflow-y: auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1001;
        }

        .memory-master-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            height: 100%;
        }

        .memory-master-main {
            padding: 20px;
            background: rgba(74, 144, 226, 0.05);
            border-radius: 12px;
        }

        .memory-master-controls {
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .memory-tutorial {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .memory-tutorial h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .memory-tutorial-section {
            margin-bottom: 25px;
            padding: 15px;
            border-left: 4px solid var(--primary-color);
            background: rgba(74, 144, 226, 0.05);
        }

        .memory-tutorial-section h4 {
            color: var(--secondary-color);
            margin-bottom: 10px;
        }

        .example-grid {
            display: grid;
            grid-template-columns: repeat(3, 50px);
            gap: 5px;
            margin: 10px 0;
        }

        .example-cell {
            width: 50px;
            height: 50px;
            border: 1px solid var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background: white;
        }

        .arrow-icon {
            font-size: 24px;
            margin: 0 10px;
        }

        .tutorial-example {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
            gap: 20px;
        }

        .mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-tab {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .memory-grid {
            display: grid;
            gap: 5px;
            margin: 20px 0;
        }

        .memory-cell {
            width: 50px;
            height: 50px;
            border: 1px solid var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
        }

        .memory-cell input {
            width: 90%;
            height: 90%;
            border: 1px solid var(--primary-color);
            text-align: center;
            font-size: 16px;
            border-radius: 4px;
        }

        .operation-selector {
            margin: 20px 0;
            padding: 10px;
            background: rgba(74, 144, 226, 0.1);
            border-radius: 8px;
        }

        .timer-display {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 15px 0;
            text-align: center;
            padding: 10px;
            background: rgba(74, 144, 226, 0.1);
            border-radius: 8px;
            min-width: 80px;
            display: inline-block;
        }

        .tutorial-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--secondary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 1002;
        }

        .tutorial-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .reset-button {
            background: var(--error-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }

        .reset-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .matrix-multiply-example {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }

        .matrix-row-display {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .operation-symbol {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <h1>Matrix Maestro (矩阵大师)</h1>
    <div class="mode-tabs">
        <div class="mode-tab active" onclick="switchMode('matrix')">矩阵大师</div>
        <div class="mode-tab" onclick="switchMode('memory')">矩阵记忆</div>
    </div>

    <div class="game-stats">
        <div class="stat-box">
            <div>Moves: <span id="moveCounter">0</span></div>
            <div>Min Required: <span id="minMoves">0</span></div>
        </div>
        <div class="stat-box">
            <div>Time: <span id="timer">00:00</span></div>
            <div>Score: <span id="score">0</span></div>
        </div>
    </div>

    <div class="game-container">
        <div class="matrix-container" id="gameMatrix">
            <!-- Matrix will be generated by JavaScript -->
        </div>

        <div class="control-panel">
            <h3>Controls</h3>
            <div>
                <button onclick="startNewGame()">New Game</button>
                <button onclick="toggleMemoryMode()">Memory Mode</button>
                <button onclick="showTutorial()">Tutorial & Rules</button>
            </div>
            <div>
                <label>Size (n):
                    <select id="matrixSize" onchange="startNewGame()">
                        <option value="3">3x3 (Tutorial)</option>
                        <option value="4">4x4 (Basic)</option>
                        <option value="5">5x5 (Advanced)</option>
                        <option value="6">6x6 (Expert)</option>
                    </select>
                </label>
            </div>
            <div class="operation-preview">
                <h4>Next Operation</h4>
                <div id="operationPreview">Select a row and range</div>
            </div>
            <div class="hint-system">
                <h4>Training Tips</h4>
                <div id="hints">Focus on building patterns column by column</div>
            </div>
        </div>
    </div>

    <div class="memory-challenge" id="memoryChallenge">
        <h3>Memory Challenge!</h3>
        <p>Recall the number at position:</p>
        <div id="memoryQuestion"></div>
        <input type="number" id="memoryAnswer">
        <button onclick="checkMemoryAnswer()">Submit</button>
    </div>

    <div id="tutorialModal" class="tutorial-modal" style="display: none;">
        <button class="close-button" onclick="closeTutorial()">&times;</button>
        <h2>Matrix Maestro Tutorial</h2>
        
        <div class="tutorial-section">
            <h3>🎯 Game Objective</h3>
            <p>Transform the initial matrix where each column j contains all j's into a matrix where each column is a permutation of numbers from 1 to n.</p>
            <div class="example-matrix">
Initial Matrix:    Goal Matrix:
1 2 3             1 2 3
1 2 3     →      2 3 1
1 2 3             3 1 2
            </div>
        </div>

        <div class="tutorial-section">
            <h3>🎮 How to Play</h3>
            <ul>
                <li><strong>Select Row:</strong> Click any cell in the row you want to modify</li>
                <li><strong>Select Range:</strong> Click start and end cells to define the range to reverse</li>
                <li><strong>Operation:</strong> The selected range will automatically reverse after selection</li>
                <li><strong>Goal:</strong> Make each column contain unique numbers (1 to n) using minimal moves</li>
            </ul>
        </div>

        <div class="tutorial-section">
            <h3>🧠 Memory Mode</h3>
            <ul>
                <li><strong>Challenge:</strong> Matrix numbers will occasionally be hidden</li>
                <li><strong>Task:</strong> Recall the number at a specific position</li>
                <li><strong>Scoring:</strong> +100 points for correct answers, -50 for incorrect</li>
                <li><strong>Training:</strong> Improves working memory and pattern recognition</li>
            </ul>
        </div>

        <div class="tutorial-section">
            <h3>📊 Scoring System</h3>
            <ul>
                <li><strong>Move Efficiency:</strong> Less moves = Higher score</li>
                <li><strong>Time Bonus:</strong> Faster completion = More points</li>
                <li><strong>Memory Bonus:</strong> Correct recalls add extra points</li>
                <li><strong>Target Moves:</strong> n+1 for n≤4, 2n-1 for n≥5</li>
            </ul>
        </div>

        <div class="tutorial-section">
            <h3>💡 Tips & Strategies</h3>
            <ul>
                <li>Start with smaller matrices to learn patterns</li>
                <li>Plan your moves ahead - each reversal affects multiple positions</li>
                <li>Watch for patterns in successful solutions</li>
                <li>In Memory Mode, try to remember patterns rather than individual numbers</li>
            </ul>
        </div>

        <div class="tutorial-nav">
            <button onclick="closeTutorial()">Got it!</button>
        </div>
    </div>
    <div id="modalOverlay" class="modal-overlay" style="display: none;"></div>

    <div id="memoryMasterModal" class="memory-master-modal" style="display: none;">
        <button class="close-button" onclick="closeMemoryMaster()">&times;</button>
        <h2>Matrix Memory Master (矩阵记忆大师)</h2>
        
        <div class="difficulty-selector">
            <label>Matrix Size:
                <select id="memorySize" onchange="updateMemoryGrid()">
                    <option value="3">3x3 (Basic)</option>
                    <option value="4">4x4 (Standard)</option>
                    <option value="5">5x5 (Advanced)</option>
                    <option value="6">6x6 (Expert)</option>
                    <option value="8">8x8 (Master)</option>
                    <option value="10">10x10 (Grandmaster)</option>
                </select>
            </label>
        </div>

        <div class="operation-selector">
            <h3>Training Mode:</h3>
            <select id="operationType" onchange="updateOperationMode()">
                <option value="memory">Matrix Memory</option>
                <option value="rotation">Mental Rotation</option>
                <option value="multiply">Matrix Multiplication</option>
                <option value="determinant">Determinant Calculation</option>
                <option value="inverse">Matrix Inverse</option>
            </select>
        </div>

        <div class="timer-display" id="memoryTimer">05:00</div>
        
        <div class="memory-master-content">
            <div class="memory-master-main">
                <div id="memoryGrid" class="memory-grid"></div>
                <div class="control-buttons">
                    <button onclick="startMemoryChallenge()">Start Challenge</button>
                    <button onclick="checkMemoryResult()" style="display: none;">Check Result</button>
                    <button class="reset-button" onclick="resetMemoryGame()">Reset Game</button>
                </div>
            </div>
            
            <div class="memory-master-controls">
                <div class="time-settings">
                    <h3>Memory Duration Settings</h3>
                    <div class="settings-row">
                        <label>Display Duration:</label>
                        <input type="range" id="displayDuration" 
                               min="1" max="60" value="5" 
                               oninput="updateDisplayDuration(this.value)">
                        <span id="durationDisplay" class="time-display">5 seconds</span>
                    </div>
                    <div class="preset-times">
                        <div class="preset-time" onclick="setPresetTime(3)">Quick (3s)</div>
                        <div class="preset-time" onclick="setPresetTime(5)">Normal (5s)</div>
                        <div class="preset-time" onclick="setPresetTime(10)">Extended (10s)</div>
                        <div class="preset-time" onclick="setPresetTime(30)">Master (30s)</div>
                    </div>
                    <div class="settings-row">
                        <label>Custom Duration (seconds):</label>
                        <input type="number" id="customDuration" 
                               class="custom-number" min="1" max="300" 
                               value="5" onchange="setCustomTime(this.value)">
                    </div>
                </div>
            </div>
        </div>

        <div class="memory-tutorial">
            <h3>🧠 Matrix Memory Master Tutorial</h3>
            
            <div class="memory-tutorial-section">
                <h4>📊 Training Modes</h4>
                <p>Choose from five different training modes to enhance your matrix manipulation skills:</p>
                
                <div class="mode-details">
                    <h5>1. Matrix Memory (基础记忆)</h5>
                    <p>Memorize and recall the exact numbers in each position of the matrix.</p>
                    <div class="tutorial-example">
                        <div class="example-grid">
                            <div class="example-cell">2</div>
                            <div class="example-cell">-3</div>
                            <div class="example-cell">1</div>
                            <div class="example-cell">4</div>
                            <div class="example-cell">0</div>
                            <div class="example-cell">-2</div>
                            <div class="example-cell">-1</div>
                            <div class="example-cell">5</div>
                            <div class="example-cell">3</div>
                        </div>
                        <span class="arrow-icon">➜</span>
                        <div class="example-grid">
                            <div class="example-cell">?</div>
                            <div class="example-cell">?</div>
                            <div class="example-cell">?</div>
                            <div class="example-cell">?</div>
                            <div class="example-cell">?</div>
                            <div class="example-cell">?</div>
                            <div class="example-cell">?</div>
                            <div class="example-cell">?</div>
                            <div class="example-cell">?</div>
                        </div>
                    </div>

                    <h5>2. Mental Rotation (矩阵旋转)</h5>
                    <p>Memorize the matrix and mentally rotate it 90° clockwise. Train your spatial visualization ability.</p>
                    <div class="tutorial-example">
                        <div class="example-grid">
                            <div class="example-cell">1</div>
                            <div class="example-cell">2</div>
                            <div class="example-cell">3</div>
                            <div class="example-cell">4</div>
                            <div class="example-cell">5</div>
                            <div class="example-cell">6</div>
                            <div class="example-cell">7</div>
                            <div class="example-cell">8</div>
                            <div class="example-cell">9</div>
                        </div>
                        <span class="arrow-icon">➜</span>
                        <div class="example-grid">
                            <div class="example-cell">7</div>
                            <div class="example-cell">4</div>
                            <div class="example-cell">1</div>
                            <div class="example-cell">8</div>
                            <div class="example-cell">5</div>
                            <div class="example-cell">2</div>
                            <div class="example-cell">9</div>
                            <div class="example-cell">6</div>
                            <div class="example-cell">3</div>
                        </div>
                    </div>

                    <h5>3. Matrix Multiplication (矩阵乘法)</h5>
                    <p>Two matrices will be shown. Mentally calculate their product and input the result.</p>
                    <div class="matrix-multiply-example">
                        <div class="matrix-row-display">
                            <div class="matrix-group">
                                <div class="example-grid">
                                    <div class="example-cell">1</div>
                                    <div class="example-cell">2</div>
                                </div>
                            </div>
                            <span class="operation-symbol">×</span>
                            <div class="matrix-group">
                                <div class="example-grid">
                                    <div class="example-cell">3</div>
                                    <div class="example-cell">1</div>
                                </div>
                            </div>
                        </div>
                        <span class="operation-symbol">=</span>
                        <div class="matrix-group">
                            <div class="example-grid">
                                <div class="example-cell">5</div>
                                <div class="example-cell">3</div>
                            </div>
                        </div>
                    </div>

                    <h5>4. Determinant Calculation (行列式计算)</h5>
                    <p>Memorize the matrix and calculate its determinant using mental math.</p>
                    <div class="tutorial-example">
                        <div class="example-grid">
                            <div class="example-cell">2</div>
                            <div class="example-cell">1</div>
                            <div class="example-cell">-1</div>
                            <div class="example-cell">3</div>
                            <div class="example-cell">2</div>
                            <div class="example-cell">1</div>
                            <div class="example-cell">0</div>
                            <div class="example-cell">-2</div>
                            <div class="example-cell">4</div>
                        </div>
                        <span class="arrow-icon">➜</span>
                        <div class="example-cell" style="width: 100px; height: 50px;">det = 17</div>
                    </div>

                    <h5>5. Matrix Inverse (矩阵求逆)</h5>
                    <p>For 2x2 matrices, calculate the inverse matrix using mental math.</p>
                    <div class="tutorial-example">
                        <div class="example-grid" style="grid-template-columns: repeat(2, 50px);">
                            <div class="example-cell">2</div>
                            <div class="example-cell">1</div>
                            <div class="example-cell">1</div>
                            <div class="example-cell">3</div>
                        </div>
                        <span class="arrow-icon">➜</span>
                        <div class="example-grid" style="grid-template-columns: repeat(2, 50px);">
                            <div class="example-cell">3/5</div>
                            <div class="example-cell">-1/5</div>
                            <div class="example-cell">-1/5</div>
                            <div class="example-cell">2/5</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="memory-tutorial-section">
                <h4>⚙️ Difficulty Levels</h4>
                <ul>
                    <li><strong>3x3 (Basic):</strong> Perfect for beginners to learn matrix operations</li>
                    <li><strong>4x4 (Standard):</strong> Good balance of challenge and manageability</li>
                    <li><strong>5x5 (Advanced):</strong> Tests your working memory capacity</li>
                    <li><strong>6x6 (Expert):</strong> Challenges your matrix visualization skills</li>
                    <li><strong>8x8 (Master):</strong> For advanced practitioners</li>
                    <li><strong>10x10 (Grandmaster):</strong> Ultimate challenge for matrix masters</li>
                </ul>
            </div>

            <div class="memory-tutorial-section">
                <h4>⏱️ Time Settings</h4>
                <p>Customize the display duration to match your skill level:</p>
                <ul>
                    <li><strong>Quick (3s):</strong> For advanced users with excellent memory</li>
                    <li><strong>Normal (5s):</strong> Standard training duration</li>
                    <li><strong>Extended (10s):</strong> For complex operations or beginners</li>
                    <li><strong>Master (30s):</strong> For studying patterns or advanced calculations</li>
                    <li><strong>Custom:</strong> Set any duration from 1 to 300 seconds</li>
                </ul>
            </div>

            <div class="memory-tutorial-section">
                <h4>💡 Training Tips</h4>
                <ul>
                    <li>Start with smaller matrices and gradually increase size</li>
                    <li>Look for patterns and relationships between numbers</li>
                    <li>Practice mental math regularly to improve calculation speed</li>
                    <li>Use visualization techniques for rotation exercises</li>
                    <li>Break down complex operations into smaller steps</li>
                    <li>Challenge yourself with shorter display times as you improve</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            matrix: [],
            size: 3,
            moves: 0,
            score: 0,
            selectedRow: -1,
            selectedRange: { start: -1, end: -1 },
            memoryMode: 'matrix',
            timeStarted: null,
            memoryMatrix: [],
            memoryTimer: null,
            currentOperation: 'memory',
            showDuration: 5000,
            difficulty: 3,
            displayDuration: 5000,
            customDuration: 5,
            timerInterval: null
        };

        function initializeMatrix(n) {
            gameState.matrix = [];
            for (let i = 0; i < n; i++) {
                let row = [];
                for (let j = 0; j < n; j++) {
                    row.push(j + 1);
                }
                gameState.matrix.push(row);
            }
            renderMatrix();
        }

        function renderMatrix() {
            const container = document.getElementById('gameMatrix');
            container.innerHTML = '';
            
            for (let i = 0; i < gameState.matrix.length; i++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'matrix-row';
                
                for (let j = 0; j < gameState.matrix[i].length; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'matrix-cell';
                    cell.textContent = gameState.matrix[i][j];
                    cell.onclick = () => handleCellClick(i, j);
                    
                    if (gameState.selectedRow === i) {
                        if (j >= gameState.selectedRange.start && 
                            j <= gameState.selectedRange.end) {
                            cell.classList.add('selected');
                        }
                    }
                    
                    rowDiv.appendChild(cell);
                }
                container.appendChild(rowDiv);
            }
        }

        function handleCellClick(row, col) {
            if (gameState.selectedRow === -1) {
                gameState.selectedRow = row;
                gameState.selectedRange.start = col;
                gameState.selectedRange.end = col;
            } else if (gameState.selectedRow === row) {
                if (gameState.selectedRange.start === -1) {
                    gameState.selectedRange.start = col;
                    gameState.selectedRange.end = col;
                } else {
                    gameState.selectedRange.end = col;
                    performOperation();
                }
            }
            renderMatrix();
            updateOperationPreview();
        }

        function performOperation() {
            const {selectedRow: row, selectedRange: {start, end}} = gameState;
            if (row === -1 || start === -1 || end === -1) return;

            // Reverse subarray
            const subarray = gameState.matrix[row].slice(start, end + 1).reverse();
            for (let i = start; i <= end; i++) {
                gameState.matrix[row][i] = subarray[i - start];
            }

            gameState.moves++;
            updateStats();

            // Reset selection
            gameState.selectedRow = -1;
            gameState.selectedRange = {start: -1, end: -1};

            if (gameState.memoryMode && Math.random() < 0.3) {
                triggerMemoryChallenge();
            }

            renderMatrix();
            checkWinCondition();
        }

        function triggerMemoryChallenge() {
            const row = Math.floor(Math.random() * gameState.size);
            const col = Math.floor(Math.random() * gameState.size);
            const value = gameState.matrix[row][col];

            document.getElementById('memoryChallenge').style.display = 'block';
            document.getElementById('memoryQuestion').textContent = 
                `Row ${row + 1}, Column ${col + 1}`;

            // Hide matrix
            const cells = document.getElementsByClassName('matrix-cell');
            for (let cell of cells) {
                cell.textContent = '?';
            }
        }

        function checkMemoryAnswer() {
            const answer = parseInt(document.getElementById('memoryAnswer').value);
            const [row, col] = document.getElementById('memoryQuestion').textContent
                .match(/\d+/g).map(n => parseInt(n) - 1);
            
            if (answer === gameState.matrix[row][col]) {
                gameState.score += 100;
                document.getElementById('memoryChallenge').style.display = 'none';
                renderMatrix();
            } else {
                gameState.score -= 50;
                alert('Try again! Focus on remembering the patterns.');
            }
            updateStats();
        }

        function updateStats() {
            document.getElementById('moveCounter').textContent = gameState.moves;
            document.getElementById('score').textContent = gameState.score;
            
            if (gameState.timeStarted) {
                const elapsed = Math.floor((Date.now() - gameState.timeStarted) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function updateOperationPreview() {
            const preview = document.getElementById('operationPreview');
            if (gameState.selectedRow !== -1) {
                preview.textContent = `Row ${gameState.selectedRow + 1}: `;
                if (gameState.selectedRange.start !== -1) {
                    preview.textContent += 
                        `Reverse [${gameState.selectedRange.start + 1} to ${gameState.selectedRange.end + 1}]`;
                } else {
                    preview.textContent += 'Select range';
                }
            } else {
                preview.textContent = 'Select a row';
            }
        }

        function checkWinCondition() {
            // Check if each column is a permutation
            for (let j = 0; j < gameState.size; j++) {
                const seen = new Set();
                for (let i = 0; i < gameState.size; i++) {
                    seen.add(gameState.matrix[i][j]);
                }
                if (seen.size !== gameState.size) return;
            }
            
            // Victory!
            const timeBonus = Math.max(0, 1000 - Math.floor((Date.now() - gameState.timeStarted) / 1000));
            const moveBonus = Math.max(0, 1000 - gameState.moves * 50);
            gameState.score += timeBonus + moveBonus;
            
            alert(`Congratulations! You've won!\nFinal Score: ${gameState.score}`);
        }

        function toggleMemoryMode() {
            gameState.memoryMode = !gameState.memoryMode;
            document.querySelector('[onclick="toggleMemoryMode"]').textContent = 
                gameState.memoryMode ? 'Normal Mode' : 'Memory Mode';
        }

        function startNewGame() {
            gameState = {
                matrix: [],
                size: parseInt(document.getElementById('matrixSize').value),
                moves: 0,
                score: 0,
                selectedRow: -1,
                selectedRange: {start: -1, end: -1},
                memoryMode: gameState.memoryMode,
                timeStarted: Date.now()
            };
            
            document.getElementById('minMoves').textContent = 
                gameState.size <= 4 ? gameState.size + 1 : 2 * gameState.size - 1;
            
            initializeMatrix(gameState.size);
            updateStats();
        }

        function showTutorial() {
            document.getElementById('tutorialModal').style.display = 'block';
            document.getElementById('modalOverlay').style.display = 'block';
        }

        function closeTutorial() {
            document.getElementById('tutorialModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
        }

        function switchMode(mode) {
            gameState.memoryMode = mode;
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const memoryModal = document.getElementById('memoryMasterModal');
            const modalOverlay = document.getElementById('modalOverlay');
            const gameContainer = document.querySelector('.game-container');
            
            if (mode === 'memory') {
                memoryModal.style.display = 'block';
                modalOverlay.style.display = 'block';
                gameContainer.style.display = 'none';
                // Initialize the memory grid when opening the modal
                updateMemoryGrid();
            } else {
                memoryModal.style.display = 'none';
                modalOverlay.style.display = 'none';
                gameContainer.style.display = 'flex';
            }
        }

        function generateRandomMatrix(size) {
            const matrix = [];
            if (gameState.currentOperation === 'multiply') {
                // For multiplication, generate two smaller matrices with numbers 1-5
                const matrix1 = Array(size).fill().map(() => 
                    Array(size).fill().map(() => Math.floor(Math.random() * 5) + 1)
                );
                const matrix2 = Array(size).fill().map(() => 
                    Array(size).fill().map(() => Math.floor(Math.random() * 5) + 1)
                );
                return [matrix1, matrix2];
            } else {
                // For other operations, generate one matrix with numbers -9 to 9
                for (let i = 0; i < size; i++) {
                    const row = [];
                    for (let j = 0; j < size; j++) {
                        row.push(Math.floor(Math.random() * 19) - 9);
                    }
                    matrix.push(row);
                }
                return matrix;
            }
        }

        function updateMemoryGrid() {
            const size = parseInt(document.getElementById('memorySize').value);
            gameState.difficulty = size;
            const grid = document.getElementById('memoryGrid');
            grid.style.gridTemplateColumns = `repeat(${size}, 50px)`;
            grid.innerHTML = '';
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'memory-cell';
                    cell.id = `memory-${i}-${j}`;
                    grid.appendChild(cell);
                }
            }
        }

        function startMemoryChallenge() {
            // Clear any existing timer
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }

            // First ensure the grid is initialized
            if (!document.getElementById(`memory-0-0`)) {
                updateMemoryGrid();
            }
            
            gameState.memoryMatrix = generateRandomMatrix(gameState.difficulty);
            displayMatrix(gameState.memoryMatrix, true);
            
            // Update timer display
            const timerDisplay = document.getElementById('memoryTimer');
            let timeLeft = Math.floor(gameState.displayDuration / 1000);
            
            // Format time display
            timerDisplay.textContent = formatTime(timeLeft);
            
            // Start new timer
            gameState.timerInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft >= 0) {
                    timerDisplay.textContent = formatTime(timeLeft);
                }
            }, 1000);
            
            // Hide matrix after custom duration
            setTimeout(() => {
                if (gameState.timerInterval) {
                    clearInterval(gameState.timerInterval);
                    gameState.timerInterval = null;
                }
                timerDisplay.textContent = 'Time\'s up!';
                clearMatrix();
                createInputMatrix();
                document.querySelector('.control-buttons button:first-child').style.display = 'none';
                document.querySelector('.control-buttons button:nth-child(2)').style.display = 'block';
            }, gameState.displayDuration);
        }

        function formatTime(seconds) {
            return seconds < 10 ? `0${seconds}s` : `${seconds}s`;
        }

        function displayMatrix(matrix, isDisplay) {
            const grid = document.getElementById('memoryGrid');
            grid.innerHTML = '';

            if (gameState.currentOperation === 'multiply' && Array.isArray(matrix[0])) {
                // Create container for multiplication display
                const container = document.createElement('div');
                container.className = 'matrix-multiply-example';
                
                // Create row for matrices and operation
                const matrixRow = document.createElement('div');
                matrixRow.className = 'matrix-row-display';
                
                // Display first matrix
                const matrix1Div = createMatrixDisplay(matrix[0], isDisplay);
                matrixRow.appendChild(matrix1Div);
                
                // Add multiplication symbol
                const multSymbol = document.createElement('span');
                multSymbol.className = 'operation-symbol';
                multSymbol.textContent = '×';
                matrixRow.appendChild(multSymbol);
                
                // Display second matrix
                const matrix2Div = createMatrixDisplay(matrix[1], isDisplay);
                matrixRow.appendChild(matrix2Div);
                
                container.appendChild(matrixRow);
                grid.appendChild(container);
            } else {
                // Regular matrix display
                for (let i = 0; i < matrix.length; i++) {
                    for (let j = 0; j < matrix[i].length; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'memory-cell';
                        cell.id = `memory-${i}-${j}`;
                        if (isDisplay) {
                            cell.textContent = matrix[i][j];
                        } else {
                            cell.innerHTML = '<input type="number" maxlength="3" style="width: 90%; height: 90%;">';
                        }
                        grid.appendChild(cell);
                    }
                }
            }
        }

        function createMatrixDisplay(matrix, isDisplay) {
            const matrixDiv = document.createElement('div');
            matrixDiv.className = 'matrix-group';
            
            const grid = document.createElement('div');
            grid.className = 'example-grid';
            grid.style.gridTemplateColumns = `repeat(${matrix.length}, 50px)`;
            
            for (let i = 0; i < matrix.length; i++) {
                for (let j = 0; j < matrix[i].length; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'memory-cell';
                    cell.id = `memory-${i}-${j}`;
                    if (isDisplay) {
                        cell.textContent = matrix[i][j];
                    } else {
                        cell.innerHTML = '<input type="number" maxlength="3" style="width: 90%; height: 90%;">';
                    }
                    grid.appendChild(cell);
                }
            }
            
            matrixDiv.appendChild(grid);
            return matrixDiv;
        }

        function clearMatrix() {
            const cells = document.getElementsByClassName('memory-cell');
            for (let cell of cells) {
                cell.textContent = '';
            }
        }

        function createInputMatrix() {
            const size = gameState.difficulty;
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const cell = document.getElementById(`memory-${i}-${j}`);
                    cell.innerHTML = '<input type="number" maxlength="3">';
                }
            }
        }

        function checkMemoryResult() {
            let correct = 0;
            let total = gameState.difficulty * gameState.difficulty;
            
            for (let i = 0; i < gameState.difficulty; i++) {
                for (let j = 0; j < gameState.difficulty; j++) {
                    const input = document.querySelector(`#memory-${i}-${j} input`);
                    const value = parseInt(input.value);
                    if (value === gameState.memoryMatrix[i][j]) {
                        correct++;
                        input.style.backgroundColor = '#aaffaa';
                    } else {
                        input.style.backgroundColor = '#ffaaaa';
                    }
                }
            }
            
            const accuracy = (correct / total * 100).toFixed(2);
            alert(`Accuracy: ${accuracy}%\nCorrect: ${correct}/${total}`);
        }

        function updateOperationMode() {
            const operation = document.getElementById('operationType').value;
            gameState.currentOperation = operation;
            
            // Set recommended durations but keep user's custom duration if longer
            const recommendedDurations = {
                'memory': 5,
                'rotation': 8,
                'multiply': 10,
                'determinant': 12,
                'inverse': 15
            };
            
            const recommended = recommendedDurations[operation] || 5;
            if (gameState.customDuration < recommended) {
                setPresetTime(recommended);
            }
        }

        function updateDisplayDuration(seconds) {
            gameState.displayDuration = seconds * 1000;
            gameState.customDuration = parseInt(seconds);
            document.getElementById('durationDisplay').textContent = `${seconds} seconds`;
            document.getElementById('displayDuration').value = seconds;
            updatePresetHighlight(seconds);
        }

        function setPresetTime(seconds) {
            updateDisplayDuration(seconds);
            document.getElementById('displayDuration').value = seconds;
        }

        function setCustomTime(seconds) {
            seconds = Math.min(300, Math.max(1, parseInt(seconds) || 5));
            updateDisplayDuration(seconds);
            document.getElementById('displayDuration').value = seconds;
            document.getElementById('customDuration').value = seconds;
        }

        function updatePresetHighlight(seconds) {
            document.querySelectorAll('.preset-time').forEach(preset => {
                preset.classList.remove('active');
                const presetSeconds = parseInt(preset.textContent.match(/\d+/)[0]);
                if (presetSeconds === parseInt(seconds)) {
                    preset.classList.add('active');
                }
            });
        }

        // Show tutorial on first load
        window.onload = function() {
            if (!localStorage.getItem('tutorialSeen')) {
                showTutorial();
                localStorage.setItem('tutorialSeen', 'true');
            }
        };

        // Initialize game
        startNewGame();
        
        // Start timer update
        setInterval(updateStats, 1000);

        function showMemoryTutorial() {
            const tutorial = document.querySelector('.memory-tutorial');
            tutorial.style.display = tutorial.style.display === 'none' ? 'block' : 'none';
        }

        function closeMemoryMaster() {
            // Clear any existing timer
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
            
            document.getElementById('memoryMasterModal').style.display = 'none';
            document.getElementById('modalOverlay').style.display = 'none';
            document.querySelector('.game-container').style.display = 'flex';
            
            // Reset memory mode tab
            document.querySelectorAll('.mode-tab').forEach(tab => {
                if (tab.textContent.includes('Memory')) {
                    tab.classList.remove('active');
                } else {
                    tab.classList.add('active');
                }
            });
            
            // Reset the game state
            resetMemoryGame();
        }

        function resetMemoryGame() {
            // Clear any existing timer
            if (gameState.timerInterval) {
                clearInterval(gameState.timerInterval);
                gameState.timerInterval = null;
            }
            
            // Reset game state
            gameState.memoryMatrix = [];
            gameState.displayDuration = 5000;
            gameState.customDuration = 5;
            
            // Reset UI elements
            document.getElementById('displayDuration').value = 5;
            document.getElementById('customDuration').value = 5;
            document.getElementById('durationDisplay').textContent = '5 seconds';
            document.getElementById('memoryTimer').textContent = formatTime(5);
            
            // Reset matrix size to default
            document.getElementById('memorySize').value = '3';
            
            // Reset operation type to default
            document.getElementById('operationType').value = 'memory';
            gameState.currentOperation = 'memory';
            
            // Clear the grid
            clearMatrix();
            updateMemoryGrid();
            
            // Reset buttons
            document.querySelector('.control-buttons button:first-child').style.display = 'block';
            document.querySelector('.control-buttons button:nth-child(2)').style.display = 'none';
            
            // Reset preset time buttons
            document.querySelectorAll('.preset-time').forEach(preset => {
                preset.classList.remove('active');
                if (preset.textContent.includes('Normal')) {
                    preset.classList.add('active');
                }
            });
            
            // Show feedback
            alert('Game has been reset to default settings!');
        }
    </script>
</body>
</html> 